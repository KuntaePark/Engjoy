<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{fragment/default}">


<th:block layout:fragment="css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        .favorite-icon.active{
            color: #FBBF24;
        }
        /* 드롭다운 메뉴 스타일 */
        .dropdown-content { display: none; }
        .dropdown-content.show { display: block; }

         /* 카드 뒤집기 효과 */
        .word-card-wrapper {
            perspective: 1000px; /* 3D 효과를 위한 원근법 */
            height: 250px; /* 카드의 고정 높이 */
        }

        .word-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d; /* 자식 요소의 3D 위치 유지를 위함 */
        }

        .word-card-wrapper.flipped .word-card-inner {
            transform: rotateY(180deg);
        }

        .word-card-front, .word-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden; /* 뒷면이 보이지 않도록 숨김 */
            backface-visibility: hidden;
            border-radius: 0.75rem; /* rounded-xl과 동일 */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm과 동일 */
            padding: 1.5rem; /* p-6과 동일 */
            background-color: white;
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* 내용 배치를 위함 */
        }

        .word-card-back {
            transform: rotateY(180deg); /* 뒷면은 기본적으로 뒤집혀 있음 */
            justify-content: flex-start; /* 뒷면 내용은 위에서부터 시작 */
        }

        /* Popover 스타일 */
        #detail-popover {
            position: absolute; /* JavaScript로 위치 조정 */
            min-width: 250px;
        }
        .close-popover-btn {
            font-size: 1.5rem;
            line-height: 1;
        }

        /* 발음 아이콘 */
        .pron-audio-icon {
            cursor: pointer;
            color: #6B7280; /* gray-500 */
            transition: color 0.2s;
        }
        .pron-audio-icon:hover {
            color: #1D4ED8; /* blue-700 */
        }
    </style>
</th:block>

<th:block layout:fragment="script">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/ko.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 요소 가져오기 ---
            const searchForm = document.getElementById('search-form');
            const expressionContainer = document.getElementById('expression-container');
            const loadMoreBtn = document.getElementById('load-more-btn');
            const resetBtn = document.getElementById('reset-btn');
            const sortSelect = document.getElementById('sort-select');
            const filterControls = document.getElementById('filter-controls');
            const detailPopover = document.getElementById('detail-popover');
            const closePopoverBtn = detailPopover.querySelector('.close-popover-btn');


            // --- 상태 관리 변수 ---
            let currentPage = 0;
            let isLastPage = false;
            let isLoading = false;
            let currentPlayingAudio = null; // 현재 재생 중인 오디오 객체
            let currentPopoverTargetButton = null; // Popover 토글을 위한 변수
            let currentPopoverData = null;       // Popover 토글을 위한 변수

            // ✅ N/A 문제 해결을 위한 추가 변수 및 로직 시작
            let loadedWordInfo = {}; // wordInfo.json 데이터를 저장할 변수
            let wordInfoLoaded = false; // wordInfo.json 로드 완료 여부 플래그

            // 1. wordInfo.json 파일을 미리 로드
            fetch('/wordInfo/wordInfo.json') // 파일 경로: /static/wordInfo/wordInfo.json
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status} loading /wordInfo/wordInfo.json`);
                    }
                    return response.json();
                })
                .then(data => {
                    // exprId를 키로 사용하여 빠른 조회를 위한 객체 생성
                    data.forEach(item => {
                        if (item.exprId) { // exprId가 존재하는지 확인
                            loadedWordInfo[item.exprId] = item;
                        } else if (item.wordText) { // exprId가 없다면 wordText를 폴백으로 사용
                             console.warn(`wordInfo.json item missing exprId. Using wordText as key: ${item.wordText}`);
                             loadedWordInfo[item.wordText.toLowerCase()] = item;
                        }
                    });
                    console.log('wordInfo.json 로드 완료:', loadedWordInfo);
                    wordInfoLoaded = true; // ⭐ 로드 완료 후 플래그 설정
                    fetchAndRender(true); // JSON 로드 후 초기 데이터 로드 시작
                })
                .catch(error => {
                    console.error("Error loading wordInfo.json:", error);
                    wordInfoLoaded = true; // ⭐ 에러 발생 시에도 플래그 설정 (페이지 로드 진행 위함)
                    fetchAndRender(true); // 에러 발생 시에도 페이지 로드 시도
                });
            // ✅ N/A 문제 해결을 위한 추가 변수 및 로직 끝


            // --- 날짜 선택기 (flatpickr) 초기화 ---
            const datePicker = flatpickr("#date-range-picker", {
                mode: "range", dateFormat: "Y-m-d", locale: "ko",
                onChange: function(selectedDates) {
                    if (selectedDates.length === 2) {
                        document.getElementById('start-date').value = selectedDates[0].toISOString();
                        document.getElementById('end-date').value = selectedDates[1].toISOString();
                    }
                }
            });

            // --- 핵심 함수: 데이터 요청 및 렌더링 ---
            function fetchAndRender(isNewSearch = false) {
                // ⭐ N/A 문제와 Flatpickr UI 문제를 해결하기 위해 이 로직이 반드시 필요합니다!
                // wordInfo.json이 아직 로드되지 않았다면 대기
                if (!wordInfoLoaded) {
                    console.log("wordInfo.json is not loaded yet. Waiting for it...");
                    return; // 로드가 완료되지 않았다면 함수 실행 중단
                }

                // 기존 fetchAndRender 함수의 시작 부분 (중복 제거됨)
                if (isLoading || (isLastPage && !isNewSearch)) return;
                isLoading = true;
                loadMoreBtn.innerText = '로딩 중...';

                if (isNewSearch) {
                    currentPage = 0;
                    isLastPage = false;
                    expressionContainer.innerHTML = '';
                }

                const formData = new FormData(searchForm);
                const params = new URLSearchParams();
                formData.forEach((value, key) => {
                    if (value) params.append(key, value);
                });
                params.append('page', currentPage);
                params.append('sort', sortSelect.value);

                fetch(`/expressions/api?${params.toString()}`)
                .then(response => response.json())
                .then(pageData => {
                    pageData.content.forEach(expr => {
                        // ✅ API 응답 데이터와 wordInfo.json 데이터 병합
                        // expr.exprId 사용 (혹은 wordText 폴백)
                        const detailedWordInfo = loadedWordInfo[expr.exprId] || loadedWordInfo[expr.wordText ? expr.wordText.toLowerCase() : ''];

                        if (detailedWordInfo) {
                            // Object.assign으로 expr 객체에 상세 정보 추가
                            Object.assign(expr, detailedWordInfo);
                        } else {
                            console.warn(`No detailed info found in wordInfo.json for exprId: ${expr.exprId} (wordText: ${expr.wordText}). Some fields might be N/A.`);
                        }

                        const cardHtml = createExpressionCard(expr);
                        expressionContainer.insertAdjacentHTML('beforeend', cardHtml);
                    });
                    isLastPage = pageData.last;
                    loadMoreBtn.classList.toggle('hidden', isLastPage);
                    currentPage++;
                })
                .catch(console.error)
                .finally(() => {
                    isLoading = false;
                    loadMoreBtn.innerText = '더보기 (More)';
                });
            }

            // --- 단어 카드 HTML 생성 함수 ---
            function createExpressionCard(expr) {
                const typeBadge = expr.exprType === 'WORD'
                    ? `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">단어</span>`
                    : `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">문장</span>`;

                const difficultyHtml = `
                    <div class="flex items-center">
                        <span class="text-sm text-gray-500 mr-2">난이도:</span>
                        <span class="text-sm font-bold text-gray-800">${expr.difficulty || 'N/A'}</span>
                    </div>
                `;

                const audioIcon = expr.pronAudio ?
                    `<button class="pron-audio-icon text-2xl" data-audio-src="${expr.pronAudio}">
                        <i class="fa-solid fa-volume-high"></i>
                    </button>` : '';

                // `data-word-info` 속성에 필요한 상세 정보를 JSON 문자열로 저장
                const wordInfoData = {
                    part_of_speech: expr.part_of_speech || 'N/A',
                    synonyms: expr.synonyms || 'N/A',
                    antonyms: expr.antonyms || 'N/A',
                    collocations: expr.collocations || 'N/A',
                };

                return `
                <div class="word-card-wrapper">
                    <div class="word-card-inner" data-expr-id="${expr.exprId}">
                        <div class="word-card-front flex flex-col justify-between items-center text-center p-6 cursor-pointer">
                            <div class="w-full flex justify-between items-center mb-4">
                                <div class="flex-none"> ${audioIcon} </div>
                                <button data-expr-id="${expr.exprId}" class="favorite-button text-gray-400 hover:text-yellow-400 text-2xl flex-grow text-center">
                                    <i class="fa-solid fa-star favorite-icon ${expr.favorite ? 'active' : ''}"></i>
                                </button>
                                <div class="flex-none"> ${difficultyHtml} </div>
                            </div>
                            <h3 class="text-3xl font-bold text-gray-900 flex-grow flex items-center justify-center">${expr.wordText}</h3>
                        </div> <div class="word-card-back flex flex-col justify-between p-6">
                            <div>
                                <p class="text-gray-700 text-lg mb-2"><strong class="text-blue-600">뜻:</strong> ${expr.meaning}</p>
                                <p class="text-gray-600 text-md italic mb-1"><strong class="text-green-600">예문:</strong> ${expr.exp_sentence || 'N/A'}</p>
                                <p class="text-gray-500 text-sm"><strong class="text-green-600">예문 뜻:</strong> ${expr.exp_sentence_mean || 'N/A'}</p>
                            </div>
                            <div class="flex justify-end mt-4">
                                <button class="detail-popover-button text-sm font-medium text-blue-600 hover:text-blue-800"
                                        data-word-info='${JSON.stringify(wordInfoData)}'>
                                    자세히보기
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
            }

            // --- 헬퍼 함수: 발음 재생 ---
            function playAudio(src) {
                if (currentPlayingAudio) {
                    currentPlayingAudio.pause();
                    currentPlayingAudio.currentTime = 0;
                }
                currentPlayingAudio = new Audio(src);
                currentPlayingAudio.play().catch(e => console.error("Audio playback failed:", e));
            }

            // --- 헬퍼 함수: 자세히보기 Popover 열기/닫기 ---
            function openDetailPopover(buttonElement, wordInfo) {
                const popover = document.getElementById('detail-popover');

                if (!popover.classList.contains('hidden') &&
                    (buttonElement === currentPopoverTargetButton && JSON.stringify(wordInfo) === JSON.stringify(currentPopoverData))) {
                    popover.classList.add('hidden');
                    currentPopoverTargetButton = null;
                    currentPopoverData = null;
                    return;
                }

                document.getElementById('popover-part-of-speech').innerText = wordInfo.part_of_speech;
                document.getElementById('popover-synonyms').innerText = wordInfo.synonyms;
                document.getElementById('popover-antonyms').innerText = wordInfo.antonyms;
                document.getElementById('popover-collocations').innerText = wordInfo.collocations;

                const rect = buttonElement.getBoundingClientRect();
                popover.style.top = `${window.scrollY + rect.bottom + 10}px`;
                popover.style.left = `${rect.left}px`;
                popover.classList.remove('hidden');

                currentPopoverTargetButton = buttonElement;
                currentPopoverData = wordInfo;
            }

            // --- 헬퍼 함수: 즐겨찾기 토글 ---
            function toggleFavorite(buttonElement, exprId) {
                const icon = buttonElement.querySelector('.favorite-icon');
                const token = document.querySelector("meta[name='_csrf']")?.content;
                const header = document.querySelector("meta[name='_csrf_header']")?.content;
                const headers = { 'Content-Type': 'application/json' };

                if(token && header) {
                    headers[header] = token;
                } else {
                    console.error("CSRF token or header name not found in meta tags. Cannot toggle favorite.");
                    return;
                }

                fetch(`/expressions/favorite/${exprId}`, { method: 'POST', headers: headers })
                    .then(res => {
                        if (!res.ok) {
                            if (res.status === 403) {
                                console.error('Favorite toggle failed: Access Denied (Likely CSRF or not logged in)');
                            } else {
                                console.error(`Favorite toggle failed with status: ${res.status}`);
                            }
                            throw new Error('Favorite toggle failed');
                        }
                        return res.json();
                    })
                    .then(isFavorite => {
                        icon.classList.toggle('active', isFavorite);
                    })
                    .catch(error => {
                        console.error("Error toggling favorite:", error);
                    });
            }

            // --- 이벤트 리스너 ---
            searchForm.addEventListener('submit', e => { e.preventDefault(); fetchAndRender(true); });
            resetBtn.addEventListener('click', () => {
                searchForm.reset();
                datePicker.clear();
                document.getElementById('start-date').value = '';
                document.getElementById('end-date').value = '';
                fetchAndRender(true);
            });
            loadMoreBtn.addEventListener('click', () => fetchAndRender(false));
            sortSelect.addEventListener('change', () => fetchAndRender(true));
            filterControls.addEventListener('change', () => fetchAndRender(true));

            // --- 이벤트 위임: 동적으로 생성된 카드들의 버튼 처리 ---
            expressionContainer.addEventListener('click', (e) => {
                const cardInner = e.target.closest('.word-card-inner');
                const favoriteButton = e.target.closest('.favorite-button');
                const pronAudioIcon = e.target.closest('.pron-audio-icon');
                const detailPopoverButton = e.target.closest('.detail-popover-button');

                // 발음 재생
                if (pronAudioIcon) {
                    e.stopPropagation();
                    const audioSrc = pronAudioIcon.dataset.audioSrc;
                    playAudio(audioSrc);
                    return;
                }

                // 즐겨찾기 토글
                if (favoriteButton) {
                    e.stopPropagation();
                    toggleFavorite(favoriteButton, favoriteButton.dataset.exprId);
                    return;
                }

                // 자세히보기 Popover 열기
                if (detailPopoverButton) {
                    e.stopPropagation();
                    openDetailPopover(detailPopoverButton, JSON.parse(detailPopoverButton.dataset.wordInfo));
                    return;
                }

                // 카드 뒤집기 (버튼 클릭이 아닐 경우만)
                if (cardInner) {
                    // Popover가 열려있을 경우 닫고 카드 뒤집기
                    if (!detailPopover.classList.contains('hidden')) {
                        detailPopover.classList.add('hidden');
                        currentPopoverTargetButton = null;
                        currentPopoverData = null;
                    }
                    cardInner.parentNode.classList.toggle('flipped');
                }
            });

            // Popover 닫기 버튼
            closePopoverBtn.addEventListener('click', () => {
                detailPopover.classList.add('hidden');
                currentPopoverTargetButton = null;
                currentPopoverData = null;
            });

            // Popover 외부 클릭 시 닫기
            window.addEventListener('click', (event) => {
                if (!detailPopover.contains(event.target) && !event.target.closest('.detail-popover-button')) {
                    detailPopover.classList.add('hidden');
                    currentPopoverTargetButton = null;
                    currentPopoverData = null;
                }
            });
        });
    </script>
</th:block>


<th:block layout:fragment="main">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-gray-900">나의 단어장</h1>
            <p class="text-lg text-gray-600 mt-2">학습한 단어와 문장을 복습하고 관리하세요.</p>
        </header>

        <div class="bg-white p-6 rounded-xl shadow-sm mb-8">
            <form id="search-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <div class="md:col-span-4">
                    <label for="keyword" class="block text-sm font-medium text-gray-700">키워드</label>
                    <input type="text" id="keyword" name="keyword" placeholder="단어 또는 문장 입력" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
                <div id="filter-controls" class="md:col-span-3 grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                        <label for="sort-select" class="block text-sm font-medium text-gray-700">정렬</label>
                        <select id="sort-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            <option value="id,desc">최신순</option><option value="id,asc">과거순</option>
                            <option value="difficulty,asc">난이도 오름차순</option><option value="difficulty,desc">난이도 내림차순</option>
                        </select>
                    </div>
                    <div>
                        <label for="exprType" class="block text-sm font-medium text-gray-700">타입</label>
                        <select id="exprType" name="exprType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            <option value="">전체</option><option value="WORD">단어</option><option value="SENTENCE">문장</option>
                        </select>
                    </div>
                    <div>
                        <label for="date-range-picker" class="block text-sm font-medium text-gray-700">기간</label>
                        <input type="text" id="date-range-picker" placeholder="기간 선택" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        <input type="hidden" name="startDate" id="start-date"><input type="hidden" name="endDate" id="end-date">
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button type="submit" class="w-full flex justify-center py-2 px-4 rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">검색</button>
                    <button type="button" id="reset-btn" class="w-full flex justify-center py-2 px-4 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 border">초기화</button>
                </div>
            </form>
        </div>

        <div id="expression-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

        <div class="text-center mt-8">
            <button id="load-more-btn" class="bg-yellow-400 text-black font-bold py-3 px-8 rounded-full hidden">더보기 (More)</button>
        </div>
    </div>

    <div id="detail-popover" class="absolute bg-white border border-gray-300 p-4 rounded-md shadow-lg hidden z-50">
        <button class="close-popover-btn float-right text-gray-500 hover:text-gray-700">&times;</button>
        <h4 class="font-bold mb-2">상세 정보</h4>
        <dl class="space-y-2 text-sm">
            <div><dt class="font-medium text-gray-600">품사</dt><dd id="popover-part-of-speech" class="mt-1"></dd></div>
            <div><dt class="font-medium text-gray-600">동의어</dt><dd id="popover-synonyms" class="mt-1"></dd></div>
            <div><dt class="font-medium text-gray-600">반의어</dt><dd id="popover-antonyms" class="mt-1"></dd></div>
            <div><dt class="font-medium text-gray-600">연어</dt><dd id="popover-collocations" class="mt-1"></dd></div>
        </dl>
    </div>

</th:block>
</html>