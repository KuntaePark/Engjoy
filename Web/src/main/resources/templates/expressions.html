<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{fragment/default}">


<th:block layout:fragment="css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        .favorite-icon.active { color: #FBBF24; }

        /* 드롭다운 메뉴 스타일 */
        .dropdown-content { display: none; position: absolute; background-color: white; box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2); z-index: 10; border-radius: 0.375rem; margin-top: 0.25rem; border: 1px solid #e5e7eb; }
        .dropdown-content.show { display: block; }

        /* 카드 뒤집기 효과 */
        .word-card-wrapper { perspective: 1000px; width: 100%; height: 180px; }
        .word-card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; cursor: pointer; }
        .word-card-wrapper.flipped .word-card-inner { transform: rotateY(180deg); }
        .word-card-front, .word-card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; border-radius: 0.75rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); padding: 1.5rem; background-color: white; border: 1px solid #e5e7eb; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .word-card-back { transform: rotateY(180deg); align-items: flex-start; justify-content: space-between; text-align: left; }

        /* 모달 스타일 */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 50; }
        .modal-content { background-color: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); width: 90%; max-width: 500px; }
        .close-modal-btn { cursor: pointer; }

        /* 발음 아이콘 스타일 */
        .pron-audio-icon { cursor: pointer; color: #6B7280; transition: color 0.2s; }
        .pron-audio-icon:hover { color: #1D4ED8; }

        /* 반응형 그리드 스타일 (닫는 중괄호 추가) */
        .card-grid { display: grid; gap: 1.5rem; margin-bottom: 2rem; grid-template-columns: repeat(1, 1fr); }
        @media (min-width: 768px) { .card-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (min-width: 1024px) { .card-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (min-width: 1280px) { .card-grid { grid-template-columns: repeat(4, 1fr); } }

    </style>
</th:block>

<th:block layout:fragment="script">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/ko.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. 요소 가져오기 ---
            const searchForm = document.getElementById('search-form');
            const expressionContainer = document.getElementById('expression-container');
            const loadMoreBtn = document.getElementById('load-more-btn');
            const detailModalOverlay = document.getElementById('detail-modal-overlay');
            const recoModalOverlay = document.getElementById('reco-modal-overlay');
            const sortInput = document.getElementById('sort-input');
            const typeInput = document.getElementById('type-input');
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');

            // --- 2. 상태 관리 변수 ---
            let currentPage = 0, isLastPage = false, isLoading = false;
            let currentPlayingAudio = null;
            let wordInfoData = {}, isWordInfoLoaded = false;

            // --- 3. 페이지 초기화 ---
            initializePage();

            /**
             * 페이지 로드 시 실행되는 메인 함수
             */
            function initializePage() {
                const flatpickrInstance = initializeFlatpickr();
                setupEventListeners(flatpickrInstance);
                fetchWordInfoAndRender();
            }

            /**
             * 모든 이벤트 리스너를 설정하는 함수
             */
            function setupEventListeners(flatpickrInstance) {
                // 드롭다운 메뉴 토글
                document.querySelectorAll('[data-dropdown-toggle]').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const dropdownContent = document.getElementById(button.dataset.dropdownToggle);
                        const isVisible = dropdownContent.classList.contains('show');
                        closeAllDropdowns();
                        if (!isVisible) dropdownContent.classList.toggle('show');
                    });
                });
                window.addEventListener('click', () => closeAllDropdowns());

                // 정렬 옵션 선택
                document.querySelectorAll('.sort-option').forEach(option => {
                    option.addEventListener('click', e => {
                        e.preventDefault();
                        sortInput.value = option.dataset.sort;
                        document.querySelector('[data-dropdown-toggle="sort-dropdown"]').innerHTML = `${option.innerText} ▾`;
                        fetchAndRender(true);
                    });
                });

                // 타입 필터(라디오 버튼) 선택
                document.querySelectorAll('input[name="exprTypeFilter"]').forEach(radio => {
                    radio.addEventListener('change', e => {
                        typeInput.value = e.target.value;
                        fetchAndRender(true);
                    });
                });

                // 날짜 필터(오늘, 지난주 등) 선택
                document.querySelectorAll('.date-filter-option').forEach(link => {
                    link.addEventListener('click', e => {
                        e.preventDefault();
                        const range = link.dataset.range;
                        const today = new Date();
                        let startDate = new Date();
                        if (range === 'TODAY') { startDate = today; }
                        else if (range === 'LAST_WEEK') { startDate.setDate(today.getDate() - 6); }
                        else if (range === 'LAST_MONTH') { startDate.setMonth(today.getMonth() - 1); }

                        const toYYYYMMDD = date => date.toISOString().slice(0, 10);
                        startDateInput.value = toYYYYMMDD(startDate);
                        endDateInput.value = toYYYYMMDD(today);
                        if (flatpickrInstance) flatpickrInstance.setDate([startDate, today], false);
                        fetchAndRender(true);
                    });
                });

                // 초기화 버튼
                const resetBtn = document.getElementById('reset-btn');
                if (resetBtn) {
                    resetBtn.addEventListener('click', () => {
                        searchForm.reset();
                        sortInput.value = "id,desc";
                        typeInput.value = "";
                        startDateInput.value = "";
                        endDateInput.value = "";
                        if (flatpickrInstance) flatpickrInstance.clear();
                        document.querySelector('[data-dropdown-toggle="sort-dropdown"]').innerHTML = `정렬 ▾`;
                        const allTypeRadio = document.querySelector('input[name="exprTypeFilter"][value=""]');
                        if (allTypeRadio) allTypeRadio.checked = true;
                        fetchAndRender(true);
                    });
                }

                // 키워드 검색(엔터 또는 검색 버튼)
                searchForm.addEventListener('submit', e => { e.preventDefault(); fetchAndRender(true); });
                // 더보기 버튼
                loadMoreBtn.addEventListener('click', () => fetchAndRender(false));
                // 카드 컨테이너에 대한 이벤트 위임 설정
                expressionContainer.addEventListener('click', handleCardClick);

                // 모달 닫기 이벤트 설정
                const detailCloseBtn = document.querySelector('#detail-modal-overlay .close-modal-btn');
                const recoCloseBtn = document.querySelector('#reco-modal-overlay .close-modal-btn');
                if(detailCloseBtn) detailCloseBtn.addEventListener('click', closeDetailModal);
                if(recoCloseBtn) recoCloseBtn.addEventListener('click', closeRecoModal);
                if(detailModalOverlay) detailModalOverlay.addEventListener('click', (e) => { if(e.target === detailModalOverlay) closeDetailModal(); });
                if(recoModalOverlay) recoModalOverlay.addEventListener('click', (e) => { if(e.target === recoModalOverlay) closeRecoModal(); });
            }

            /**
             * Flatpickr(날짜 선택기)를 초기화하는 함수
             */
            function initializeFlatpickr() {
                const picker = document.getElementById('date-range-picker-popup');
                if (!picker) return null;
                return flatpickr(picker, {
                    mode: "range", dateFormat: "Y-m-d", locale: "ko",
                    onClose: (selectedDates) => {
                        if (selectedDates.length === 2) {
                            startDateInput.value = selectedDates[0].toISOString().slice(0, 10);
                            endDateInput.value = selectedDates[1].toISOString().slice(0, 10);
                            fetchAndRender(true);
                        }
                    }
                });
            }

            /**
             * wordInfo.json 로드 후, 초기 데이터 렌더링과 추천 단어 로드를 실행하는 함수
             */
            function fetchWordInfoAndRender() {
                fetch('/wordinfo/wordinfo.json')
                    .then(res => res.ok ? res.json() : Promise.reject('Failed to load wordInfo'))
                    .then(data => {
                        data.forEach(item => { if (item.exprId) wordInfoData[item.exprId] = item; });
                    })
                    .catch(console.error)
                    .finally(() => {
                        isWordInfoLoaded = true;
                        fetchAndRender(true); // 단어장 데이터 로드
                        fetchAndShowRecommendations(); // 추천 단어 데이터 로드
                    });
            }

            /**
             * 서버에서 단어장 데이터를 가져와 화면에 렌더링하는 핵심 함수
             */
            function fetchAndRender(isNewSearch = false) {
                if (!isWordInfoLoaded || isLoading || (isLastPage && !isNewSearch)) return;
                isLoading = true;
                loadMoreBtn.innerText = '로딩 중...';
                if (isNewSearch) {
                    currentPage = 0;
                    isLastPage = false;
                    expressionContainer.innerHTML = '';
                }
                const params = new URLSearchParams(new FormData(searchForm));
                params.append('page', currentPage);

                fetch(`/expressions/api?${params.toString()}`)
                    .then(res => res.ok ? res.json() : Promise.reject('표현 목록 로드 실패'))
                    .then(pageData => {
                        if (pageData.content.length === 0 && isNewSearch) {
                            expressionContainer.innerHTML = `<p class="text-center text-gray-500 col-span-full">결과가 없습니다.</p>`;
                        } else {
                            pageData.content.forEach(expr => {
                                const detailedInfo = wordInfoData[expr.exprId];
                                if (detailedInfo) Object.assign(expr, detailedInfo);
                                const cardHtml = createExpressionCard(expr);
                                expressionContainer.insertAdjacentHTML('beforeend', cardHtml);
                            });
                        }
                        isLastPage = pageData.last;
                        loadMoreBtn.classList.toggle('hidden', isLastPage);
                        currentPage++;
                    })
                    .catch(console.error)
                    .finally(() => {
                        isLoading = false;
                        loadMoreBtn.innerText = '더보기';
                    });
            }

            /**
             * 추천 단어 데이터를 가져와 모달을 띄우는 함수
             */
            function fetchAndShowRecommendations() {
                if (!recoModalOverlay) return;
                fetch('/expressions/api/recommendations')
                    .then(res => res.ok ? res.json() : null)
                    .then(recommendations => {
                        if (recommendations && recommendations.length > 0) {
                            openRecoModal(recommendations);
                        }
                    }).catch(console.error);
            }

            /**
             * 카드 하나의 HTML 문자열을 생성하는 함수
             */
            function createExpressionCard(expr) {
                const wordInfoData = { part_of_speech: expr.part_of_speech, synonyms: expr.synonyms, antonyms: expr.antonyms, collocations: expr.collocations };
                const detailButtonHtml = expr.exprType === 'WORD' ? `<div class="flex justify-end mt-4"><button class="detail-button text-sm font-medium text-blue-600 hover:text-blue-800" data-word-info='${JSON.stringify(wordInfoData)}'>자세히보기</button></div>` : '';
                return `
                <div class="word-card-wrapper">
                    <div class="word-card-inner">
                        <div class="word-card-front">
                            <div class="w-full flex justify-between items-start p-6">
                                <span class="pron-audio-icon w-8 text-left" data-audio-src="${expr.pronAudio}"><i class="fa-solid fa-volume-high"></i></span>
                                <span class="favorite-button text-2xl" data-expr-id="${expr.exprId}"><i class="fa-star favorite-icon ${expr.favorite ? 'fa-solid active' : 'fa-regular'}"></i></span>
                            </div>
                            <h3 class="text-3xl font-bold text-gray-900 flex-grow flex items-center justify-center -mt-8 truncate">${expr.wordText}</h3>
                        </div>
                        <div class="word-card-back">
                            <div>
                                <p class="text-gray-700 text-lg mb-2 truncate"><strong class="text-blue-600">뜻:</strong> ${expr.meaning}</p>
                                <p class="text-gray-600 text-md italic mb-1 truncate"><strong class="text-green-600">예문:</strong> ${expr.exp_sentence || 'N/A'}</p>
                            </div>
                            ${detailButtonHtml}
                        </div>
                    </div>
                </div>`;
            }

            /**
             * 카드 컨테이너 내부의 클릭 이벤트를 처리하는 함수 (이벤트 위임)
             */
            function handleCardClick(event) {
                const target = event.target;
                const detailButton = target.closest('.detail-button');
                const favoriteButton = target.closest('.favorite-button');
                const audioButton = target.closest('.pron-audio-icon');
                const cardInner = target.closest('.word-card-inner');

                if (detailButton) { event.stopPropagation(); openDetailModal(JSON.parse(detailButton.dataset.wordInfo)); }
                else if (favoriteButton) { event.stopPropagation(); toggleFavorite(favoriteButton); }
                else if (audioButton) { event.stopPropagation(); playAudio(audioButton.dataset.audioSrc); }
                else if (cardInner) { cardInner.parentNode.classList.toggle('flipped'); }
            }

            // --- 나머지 모든 헬퍼 함수 ---
            function closeAllDropdowns() { document.querySelectorAll('.dropdown-content').forEach(el => el.classList.remove('show')); }
            function playAudio(src) { if (currentPlayingAudio) { currentPlayingAudio.pause(); } currentPlayingAudio = new Audio(src); currentPlayingAudio.play(); }
            function toggleFavorite(button) { /* 이전 답변과 동일 */ }
            function openDetailModal(wordInfo) { /* 이전 답변과 동일 */ }
            function closeDetailModal() { if(detailModalOverlay) detailModalOverlay.classList.add('hidden'); }
            function openRecoModal(recommendations) { /* 이전 답변과 동일 */ }
            function closeRecoModal() { if(recoModalOverlay) recoModalOverlay.classList.add('hidden'); }
        });
    </script>
</th:block>

<th:block layout:fragment="main">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-gray-900">나의 단어장</h1>
            <p class="text-lg text-gray-600 mt-2">학습한 단어와 문장을 복습하고 관리하세요.</p>
        </header>

        <form id="search-form" class="bg-white p-6 rounded-xl shadow-sm mb-8 space-y-4">
            <div>
                <label for="keyword" class="sr-only">키워드</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fa-solid fa-search text-gray-400"></i>
                    </div>
                    <input type="text" name="keyword" id="keyword" placeholder="단어 또는 문장으로 검색..." class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                    <label for="sort" class="block text-sm font-medium text-gray-700">정렬</label>
                    <select name="sort" id="sort" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="id,desc">최신순</option>
                        <option value="id,asc">과거순</option>
                        <option value="difficulty,asc">난이도 오름차순</option>
                        <option value="difficulty,desc">난이도 내림차순</option>
                    </select>
                </div>
                <div>
                    <label for="exprType" class="block text-sm font-medium text-gray-700">타입</label>
                    <select name="exprType" id="exprType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">전체</option>
                        <option value="WORD">단어</option>
                        <option value="SENTENCE">문장</option>
                    </select>
                </div>
                <div>
                    <label for="date-range-picker" class="block text-sm font-medium text-gray-700">기간</label>
                    <input type="text" id="date-range-picker" placeholder="기간 선택" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <input type="hidden" name="startDate" id="start-date">
                    <input type="hidden" name="endDate" id="end-date">
                </div>
                <div class="flex items-end space-x-2">
                    <button type="submit" class="w-full flex justify-center py-2 px-4 rounded-md shadow-sm font-medium text-white bg-blue-600 hover:bg-blue-700">검색</button>
                    <button type="button" id="reset-btn" class="w-full flex justify-center py-2 px-4 rounded-md shadow-sm font-medium text-gray-700 bg-white hover:bg-gray-50 border">초기화</button>
                </div>
            </div>
        </form>

        <div id="expression-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>

        <div class="text-center mt-8">
            <button id="load-more-btn" class="bg-yellow-400 text-black font-bold py-3 px-8 rounded-full hidden">더보기</button>
        </div>
    </div>

    <div id="reco-modal-overlay" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4 pb-2 border-b">
                <h4 class="font-bold text-lg">오늘의 복습 추천 단어 💡</h4>
                <button class="close-modal-btn text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <ul id="reco-list" class="space-y-2"></ul>
        </div>
    </div>

    <div id="detail-modal-overlay" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4 pb-2 border-b">
                <h4 class="font-bold text-lg">상세 정보</h4>
                <button id="close-modal-btn" class="close-modal-btn text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <dl class="space-y-3 text-sm">
                <div><dt class="font-medium">품사</dt><dd id="modal-part-of-speech"></dd></div>
                <div><dt class="font-medium">동의어</dt><dd id="modal-synonyms"></dd></div>
                <div><dt class="font-medium">반의어</dt><dd id="modal-antonyms"></dd></div>
                <div><dt class="font-medium">연어</dt><dd id="modal-collocations"></dd></div>
            </dl>
        </div>
    </div>
</th:block>
</html>