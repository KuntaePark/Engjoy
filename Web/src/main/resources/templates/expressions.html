<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{fragment/default}">

<th:block layout:fragment="css">
    <style>
        .favorite-icon.active{
            color: #FBBF24;
        }
    </style>
</th:block>

<th:block layout:fragment="script">
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 자세히보기 모달 처리 ---
            const detailModal = document.getElementById('detail-modal');
            const modalContent = document.getElementById('modal-content');
            const modalCloseBtn = document.getElementById('modal-close-btn');

            // '자세히보기' 버튼들에 이벤트 리스너 추가
            document.querySelectorAll('.detail-button').forEach(button => {
                button.addEventListener('click', () => {
                    const exprId = button.dataset.exprId;
                    modalContent.innerHTML = '<p class="text-sm text-gray-500">로딩 중...</p>';
                    if (detailModal) detailModal.classList.remove('hidden');

                    // 서버에 상세 정보 요청 (GET)
                    fetch(`/expressions/detail/${exprId}`)
                        .then(response => {
                            if (!response.ok) throw new Error('Network response was not ok');
                            return response.json();
                        })
                        .then(data => {
                            // 받은 데이터로 모달 내용 채우기
                            // WordInfoDto 구조에 맞춰서 HTML을 생성합니다.
                            modalContent.innerHTML = `
                                <div class="space-y-3">
                                    <div>
                                        <dt class="font-medium text-gray-900">단어/문장</dt>
                                        <dd class="mt-1 text-gray-700">${data.wordText || 'N/A'}</dd>
                                    </div>
                                    <div>
                                        <dt class="font-medium text-gray-900">뜻</dt>
                                        <dd class="mt-1 text-gray-700">${data.meaning || 'N/A'}</dd>
                                    </div>
                                    <div>
                                        <dt class="font-medium text-gray-900">예문</dt>
                                        <dd class="mt-1 text-gray-700">${data.exampleSentence || 'N/A'}</dd>
                                    </div>
                                    <!-- 여기에 WordInfoDto의 다른 필드들도 추가할 수 있습니다. -->
                                </div>
                            `;
                        })
                        .catch(error => {
                            console.error('Error fetching detail:', error);
                            modalContent.innerHTML = '<p class="text-sm text-red-500">정보를 불러오는 데 실패했습니다.</p>';
                        });
                });
            });

            // 모달 닫기 버튼
            if(modalCloseBtn) {
                modalCloseBtn.addEventListener('click', () => {
                    detailModal.classList.add('hidden');
                });
            }

            // 모달 외부 클릭 시 닫기
            window.addEventListener('click', (event) => {
                if (event.target === detailModal) {
                    detailModal.classList.add('hidden');
                }
            });


            // --- 즐겨찾기 상태 변경 처리 ---
            document.querySelectorAll('.favorite-button').forEach(button => {
                button.addEventListener('click', () => {
                    const exprId = button.dataset.exprId;
                    const icon = button.querySelector('.favorite-icon');

                    // 서버에 즐겨찾기 상태 변경 요청 (POST)
                    fetch(`/expressions/favorite/${exprId}`, {
                        method: 'POST',
                        headers: {
                            // CSRF 토큰이 필요하다면 여기에 추가해야 합니다.
                            // 'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').content
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            if (response.status === 401) alert('로그인이 필요합니다.');
                            throw new Error('Favorite toggle failed');
                        }
                        return response.json();
                    })
                    .then(isFavorite => {
                        // 응답(true/false)에 따라 아이콘 스타일 변경
                        icon.classList.toggle('active', isFavorite);
                    })
                    .catch(error => {
                        console.error('Error toggling favorite:', error);
                    });
                });
            });
        });
    </script>

</th:block>


<th:block layout:fragment="main">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">

        <!-- 페이지 헤더 -->
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-gray-900">나의 단어장</h1>
            <p class="text-lg text-gray-600 mt-2">학습한 단어와 문장을 복습하고 관리하세요.</p>
            <div class="mt-4">
                <a th:href="@{/incorrect}" class="text-blue-600 hover:underline">오답 노트 바로가기 &rarr;</a>
                <a th:href="@{/quizSetting}" class="btn btn-primary">복습 퀴즈</a>
            </div>
        </header>

        <!-- 검색 및 필터링 폼 -->
        <div class="bg-white p-6 rounded-xl shadow-sm mb-8">
            <form th:action="@{/expressions}" method="get" th:object="${searchDto}" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                <!-- 키워드 검색 -->
                <div>
                    <label for="keyword" class="block text-sm font-medium text-gray-700">키워드</label>
                    <input type="text" id="keyword" th:field="*{keyword}" placeholder="단어 또는 문장 입력" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <!-- 타입 선택 -->
                <div>
                    <label for="exprType" class="block text-sm font-medium text-gray-700">타입</label>
                    <select id="exprType" th:field="*{exprType}" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        <option value="">전체</option>
                        <option value="WORD">단어</option>
                        <option value="SENTENCE">문장</option>
                    </select>
                </div>
                <!-- 난이도 선택 -->
                <div>
                    <label for="difficulty" class="block text-sm font-medium text-gray-700">난이도</label>
                    <select id="difficulty" th:field="*{difficulty}" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        <option value="0">전체</option>
                        <option th:each="i : ${#numbers.sequence(1, 5)}" th:value="${i}" th:text="|Level ${i}|"></option>
                    </select>
                </div>
                <!-- 검색 버튼 -->
                <div class="flex space-x-2">
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <i class="fa-solid fa-search mr-2"></i> 검색
                    </button>
                    <a th:href="@{/expressions}" class="w-full flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                        초기화
                    </a>
                </div>
            </form>
        </div>

        <!-- 단어 카드 목록 -->
        <div th:if="${expressionPage.empty}" class="text-center py-16">
            <p class="text-gray-500 text-lg">표시할 단어가 없습니다.</p>
        </div>

        <div th:unless="${expressionPage.empty}" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div th:each="expr : ${expressionPage.content}" class="bg-white rounded-xl shadow-sm overflow-hidden transform hover:-translate-y-1 transition-transform duration-300">
                <div class="p-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <span th:text="${expr.exprType == 'WORD' ? '단어' : '문장'}"
                                  th:classappend="${expr.exprType == 'WORD' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}"
                                  class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                            </span>
                        </div>
                        <button th:data-expr-id="${expr.exprId}" class="favorite-button text-gray-400 hover:text-yellow-400 text-xl">
                            <i class="fa-solid fa-star favorite-icon" th:classappend="${expr.isFavorite ? 'active' : ''}"></i>
                        </button>
                    </div>
                    <h3 class="mt-4 text-xl font-semibold text-gray-900" th:text="${expr.wordText}"></h3>
                    <p class="mt-2 text-gray-600" th:text="${expr.meaning}"></p>
                    <div class="mt-4 flex items-center">
                        <span class="text-sm text-gray-500 mr-2">난이도:</span>
                        <div class="flex">
                            <i th:each="i : ${#numbers.sequence(1, 5)}"
                               class="fa-solid fa-star"
                               th:classappend="${i <= expr.difficulty ? 'text-yellow-400' : 'text-gray-300'}"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-6 py-4 flex justify-end">
                    <button th:data-expr-id="${expr.exprId}" class="detail-button text-sm font-medium text-blue-600 hover:text-blue-800">
                        자세히보기
                    </button>
                </div>
            </div>
        </div>

        <!-- 페이지네이션 -->
        <nav th:if="${!expressionPage.empty}" class="mt-10 flex items-center justify-between border-t border-gray-200 px-4 sm:px-0">
            <div class="flex-1 flex justify-start">
                <a th:href="${expressionPage.first} ? '#' : @{/expressions(page=${expressionPage.number - 1}, keyword=${searchDto.keyword}, exprType=${searchDto.exprType}, difficulty=${searchDto.difficulty})}"
                   th:classappend="${expressionPage.first} ? 'pointer-events-none text-gray-400' : 'text-gray-600 hover:text-gray-900'"
                   class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md bg-white">
                    이전
                </a>
            </div>
            <div class="hidden md:flex">
                <span th:each="i : ${#numbers.sequence(0, expressionPage.totalPages - 1)}"
                      th:if="${expressionPage.totalPages > 1}">
                    <a th:href="@{/expressions(page=${i}, keyword=${searchDto.keyword}, exprType=${searchDto.exprType}, difficulty=${searchDto.difficulty})}"
                       th:text="${i + 1}"
                       th:classappend="${i == expressionPage.number} ? 'bg-blue-50 border-blue-500 text-blue-600' : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'"
                       class="relative inline-flex items-center px-4 py-2 border text-sm font-medium">
                    </a>
                </span>
            </div>
            <div class="flex-1 flex justify-end">
                <a th:href="${expressionPage.last} ? '#' : @{/expressions(page=${expressionPage.number + 1}, keyword=${searchDto.keyword}, exprType=${searchDto.exprType}, difficulty=${searchDto.difficulty})}"
                   th:classappend="${expressionPage.last} ? 'pointer-events-none text-gray-400' : 'text-gray-600 hover:text-gray-900'"
                   class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md bg-white">
                    다음
                </a>
            </div>
        </nav>
    </div>

    <!-- 단어 상세 정보 모달 -->
    <div id="detail-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">상세 정보</h3>
                <div class="mt-2 px-7 py-3 text-left" id="modal-content">
                    <!-- AJAX로 내용이 채워질 부분 -->
                </div>
                <div class="items-center px-4 py-3">
                    <button id="modal-close-btn" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        닫기
                    </button>
                </div>
            </div>
        </div>
    </div>
</th:block>
</html>