<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{fragment/default}">

<head>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>

<th:block layout:fragment="css">
    <style>
        #pdf-viewer {
            max-height: 80vh;
            overflow-y: auto;
        }
    </style>
</th:block>

<th:block layout:fragment="script">
    <script src="https://mozilla.github.io/pdf.js/build/pdf.mjs" type="module"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const createPdfBtn = document.getElementById('create-pdf-btn');
            const pdfCanvas = document.getElementById('pdf-preview-canvas');
            const viewerMessage = document.getElementById('viewer-message');

            if (!createPdfBtn) return;

            createPdfBtn.addEventListener('click', () => {
                const form = document.getElementById('print-options-form');
            const formData = new FormData(form);

            let dateRangeValue = formData.get('dateRange');
            if (dateRangeValue === "") {
                dateRangeValue = null;
            }

            // 서버로 보낼 PrintOptionDto JSON 객체 생성
            const printOptionDto = {
                selectAll: formData.get('selectionType') === 'all',
                exprIdsToPrint: [],
                printForm: formData.get('printForm'),
                quizSettingDto: {
                    dateRange: dateRangeValue,
                    category: formData.get('category')
                },
                printOptionDetailDto: {
                    orderType: formData.get('orderType')
                }
            };

                // CSRF 토큰을 헤더에 추가
                const token = document.querySelector("meta[name='_csrf']")?.content;
                const header = document.querySelector("meta[name='_csrf_header']")?.content;
                const headers = { 'Content-Type': 'application/json' };
                if (token && header) {
                    headers[header] = token; // 헤더에 CSRF 토큰 추가
                }


                createPdfBtn.disabled = true;
                createPdfBtn.innerText = '미리보기 생성 중...';
                viewerMessage.innerText = 'PDF를 불러오는 중입니다...';
                viewerMessage.style.display = 'block';
                pdfCanvas.style.display = 'none';

                fetch('/print/download', {
                    method: 'POST',
                    headers: headers, // CSRF 토큰이 포함된 헤더 사용
                    body: JSON.stringify(printOptionDto)
                })
                .then(response => {
                    if (response.ok) return response.blob();
                    throw new Error('PDF 생성에 실패했습니다.');
                })
                .then(blob => {
                    const fileReader = new FileReader();
                    fileReader.onload = function() {
                        const typedarray = new Uint8Array(this.result);
                        const { pdfjsLib } = globalThis;
                        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://mozilla.github.io/pdf.js/build/pdf.worker.mjs`;

                        pdfjsLib.getDocument(typedarray).promise.then(pdf => {
                            viewerMessage.style.display = 'none';
                            pdfCanvas.style.display = 'block';
                            return pdf.getPage(1);
                        }).then(page => {
                            const viewport = page.getViewport({ scale: 1.0 });
                            const context = pdfCanvas.getContext('2d');
                            pdfCanvas.height = viewport.height;
                            pdfCanvas.width = viewport.width;
                            page.render({ canvasContext: context, viewport: viewport });
                        });
                    };
                    fileReader.readAsArrayBuffer(blob);
                })
                .catch(error => {
                    console.error('Error:', error);
                    viewerMessage.innerText = '미리보기를 표시할 수 없습니다.';
                    viewerMessage.style.display = 'block';
                })
                .finally(() => {
                    createPdfBtn.disabled = false;
                    createPdfBtn.innerText = '학습지 미리보기 생성';
                });
            });
        });
    </script>
</th:block>

<th:block layout:fragment="main">
    <div class="container mx-auto p-8 grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
        <form id="print-options-form" class="space-y-8 bg-white p-8 rounded-lg shadow-lg sticky top-8">
            <h1 class="text-3xl font-bold">학습지 인쇄 설정</h1>
            <fieldset>
                <legend class="text-lg font-medium text-gray-900">1. 인쇄 대상</legend>
                <div class="mt-2 space-y-2">
                    <div class="flex items-center"><input id="select-all" name="selectionType" type="radio" value="all" class="h-4 w-4" checked><label for="select-all" class="ml-3 text-sm">전체 단어/문장 필터링</label></div>
                    <div class="flex items-center"><input id="select-partial" name="selectionType" type="radio" value="partial" class="h-4 w-4" disabled><label for="select-partial" class="ml-3 text-sm text-gray-500">부분 선택 (개발 중)</label></div>
                </div>
            </fieldset>
            <div id="filter-options" class="space-y-4 border-t pt-4">
                <label for="category" class="block text-sm font-medium">학습 타입</label>
                <select id="category" name="category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"><option value="MIXED">전체</option><option value="WORD">단어</option><option value="SENTENCE">문장</option></select>
                <label for="dateRange" class="block text-sm font-medium">학습 기간</label>
                <select id="dateRange" name="dateRange" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"><option value="">전체 기간</option><option value="TODAY">오늘</option><option value="LAST_WEEK">최근 1주</option><option value="LAST_MONTH">최근 1달</option></select>
            </div>
            <fieldset class="border-t pt-4">
                <legend class="text-lg font-medium">2. 인쇄 형태</legend>
                <div class="mt-2 grid grid-cols-1 gap-y-2 sm:grid-cols-3 sm:gap-x-2">
                    <label class="border rounded-md p-3 flex items-center text-sm"><input type="radio" name="printForm" value="EXAM" class="h-4 w-4 mr-2" checked>시험지형</label>
                    <label class="border rounded-md p-3 flex items-center text-sm"><input type="radio" name="printForm" value="LIST" class="h-4 w-4 mr-2">리스트형</label>
                    <label class="border rounded-md p-3 flex items-center text-sm"><input type="radio" name="printForm" value="WORKSHEET" class="h-4 w-4 mr-2">워크시트형</label>
                </div>
            </fieldset>
            <div class="border-t pt-4">
                <label for="orderType" class="text-lg font-medium">3. 정렬 방식</label>
                <select id="orderType" name="orderType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"><option value="STAY">등록순</option><option value="ABC">알파벳순</option><option value="SUFF">무작위</option></select>
            </div>
            <div class="pt-4">
                <button type="button" id="create-pdf-btn" class="w-full flex justify-center py-3 px-4 rounded-md shadow-sm text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700">
                    학습지 미리보기 생성
                </button>
            </div>
        </form>
        <div id="pdf-viewer" class="bg-gray-200 p-4 rounded-lg shadow-inner flex justify-center items-center">
            <p id="viewer-message" class="text-center text-gray-500">옵션을 선택하고 버튼을 누르면 여기에 미리보기가 표시됩니다.</p>
            <canvas id="pdf-preview-canvas" class="hidden"></canvas>
        </div>
    </div>
</th:block>
</html>