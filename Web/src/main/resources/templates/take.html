<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{fragment/default}">

<head>
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>

<th:block layout:fragment="css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* ì„ íƒëœ ë‹µë³€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ë‹¨ì–´ í€´ì¦ˆìš©) */
        .answer-btn.selected {
            border: 2px solid #8CCE47;
            font-weight: 600;
        }
        /* ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê´€ë ¨ ìŠ¤íƒ€ì¼ (ë¬¸ì¥ í€´ì¦ˆìš©) */
        #answer-board .word-btn:active,
        .sortable-ghost, sortable-drag { cursor: grab }

        #word-bank .word-btn { cursor: pointer; }
    </style>
</th:block>
<th:block layout:fragment="script">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
        <script th:inline="javascript">
          document.addEventListener('DOMContentLoaded', () => {
            // â”€â”€â”€ 0) í˜ì´ì§€ ì´ë™ í—ˆìš© ì—¬ë¶€ í”Œë˜ê·¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const question       = /*[[${question}]]*/ null;
            const currentIndex   = /*[[${currentIndex}]]*/ 0;
            const totalQuestions = /*[[${totalQuestions}]]*/ 0;
            let allowNavigation = false; // ìƒˆë¡œê³ ì¹¨ ì´íƒˆ ê¹ƒë°œ ë³€ìˆ˜
            let shouldOpenExitModal = false; // ë’¤ë¡œê°€ê¸° ê¹ƒë°œ ë³€ìˆ˜

            // â”€â”€â”€ 1) ìƒˆë¡œê³ ì¹¨ ê°ì§€ & index=0 ê°•ì œ ë¦¬ë‹¤ì´ë ‰íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const params    = new URLSearchParams(window.location.search);
            const idxParam  = params.get('index') || '0';

            function setupExitListeners(){

                // ìƒˆë¡œê³ ì¹¨ ì‹œ ëª¨ë‹¬ ìƒíƒœ ì´ˆê¸°í™”
                if (performance.getEntriesByType('navigation')[0]?.type === 'reload') {
                    history.replaceState(null, '', location.href);  // ì´ˆê¸°í™”
                }
                const navEntries = performance.getEntriesByType('navigation');
                const navType    = navEntries.length
                                   ? navEntries[0].type
                                   : (performance.navigation && performance.navigation.type === 1 ? 'reload' : 'other');

                if (navType === 'reload') {
                  // ìƒˆë¡œê³ ì¹¨ í›„ index=0ìœ¼ë¡œ ëŒì•„ê°ˆ ë•Œ
                  if( idxParam !== '0'){
                      allowNavigation = true;
                      window.location.replace('/quiz/take?index=0');
                      return;
                  }
                  // ìƒˆë¡œê³ ì¹¨ì´ì§€ë§Œ index=0ì¸ ê²½ìš°ì—ë„ íˆìŠ¤í† ë¦¬ ìƒíƒœë¥¼ ì´ˆê¸°í™”
                  history.replaceState(null,'',location.href);
                }

                // â”€â”€â”€ 2) í˜ì´ì§€ ë– ë‚  ë•Œ í™•ì¸ì°½(beforeunload) ë“±ë¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                window.addEventListener('beforeunload', e => {
                  if (allowNavigation) return;
                  e.preventDefault();
                  e.returnValue = 'í€´ì¦ˆë¥¼ ë– ë‚˜ì‹œê² ìŠµë‹ˆê¹Œ? ì§„í–‰ ìƒí™©ì´ ì €ì¥ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                });

                // â”€â”€â”€ 3) ë’¤ë¡œê°€ê¸°Â·Xë²„íŠ¼ ëª¨ë‹¬ ì œì–´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

                const exitTriggerBtn = document.getElementById('exit-quiz-trigger');
                const exitModal      = document.getElementById('exit-confirm-modal');
                const continueBtn    = document.getElementById('continue-quiz-btn');
                const exitConfirmBtn = document.getElementById('exit-quiz-btn');

                if (exitTriggerBtn && exitModal && question) {
                  let popstateInitialized = false;
                  shouldOpenExitModal = true;
                  history.pushState

                   window.addEventListener('popstate', (event) => {
                   // ì²˜ìŒ ë°œìƒí•˜ëŠ” popstateëŠ” ë¬´ì‹œ
                    if(!popstateInitialized){
                        popstateInitialized = true;
                        return;
                    }
                    // ì‹¤ì œ ë’¤ë¡œê°€ê¸°ì¸ ê²½ìš°ì—ë§Œ ì‹¤í–‰
                    if (shouldOpenExitModal && event.state?.modal === true) {
                      exitModal.classList.remove('hidden');
                    }
                });

                  exitTriggerBtn.addEventListener('click', e => {
                    e.preventDefault();
                    history.pushState({modal:true},'',location.href);
                    exitModal.classList.remove('hidden');
                  });

                  continueBtn.addEventListener('click', () => {
                    exitModal.classList.add('hidden');
                    history.back();
                  });

                  exitConfirmBtn.addEventListener('click', () => {
                    allowNavigation = true;
                    window.location.href = exitTriggerBtn.href;
                  });

                  exitModal.addEventListener('click', e => {
                    if (e.target === exitModal) {
                      exitModal.classList.add('hidden');
                      history.back();
                    }
                  });
                }
            }

            // â”€â”€â”€ 4) í€´ì¦ˆ ë¡œì§ ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const quizContainer = document.getElementById('quiz-container');
            const feedbackArea  = document.getElementById('feedback-area');
            const submitBtn     = document.getElementById('submitBtn');
            const nextBtn       = document.getElementById('nextBtn');
            const skipBtn       = document.getElementById('skipBtn');
            const resetBtn      = document.getElementById('resetBtn');
            const answerBoard   = document.getElementById('answer-board');
            const wordBank      = document.getElementById('word-bank');
            const isSentenceQuiz = !!answerBoard;
            const pronAudioBtn = document.getElementById('pron-audio-btn');
            let selectedAnswer  = null;
            let currentPlayingAudio = null;

            if(question){
              setupExitListeners(); // ë‚˜ê°€ê¸°/ìƒˆë¡œê³ ì¹¨/ë’¤ë¡œê°€ê¸° ê´€ë ¨ ê¸°ëŠ¥ í™œì„±í™”
              checkSubmitButtonState(); // ì œì¶œ ë²„íŠ¼ ì´ˆê¸° ìƒíƒœ ì„¤ì •
            }

            // ì§„í–‰ë°”
            const progressBar = document.getElementById('progressBar');
            if (progressBar && totalQuestions > 0) {
              progressBar.style.width = `${((currentIndex + 1) / totalQuestions) * 100}%`;
            }

            // ì œì¶œ ë²„íŠ¼ í™œì„±/ë¹„í™œì„± ì²´í¬
            function checkSubmitButtonState() {
              if (!submitBtn) return;
              const answered = isSentenceQuiz
                ? answerBoard.children.length > 0
                : selectedAnswer !== null;
              submitBtn.disabled = !answered;
            }



              // --- í€´ì¦ˆ ìœ í˜•ë³„ ë¡œì§ ---
              if (isSentenceQuiz) {
                  let initialBankWords = [], bankWords = [], answerWords = [];
                  const wordBtnClasses = "word-btn flex-none px-6 py-2 bg-white border border-gray-200 border-b-4 rounded-2xl text-gray-600 font-bold transition-all hover:bg-gray-50 active:border-b-0 active:translate-y-px";

                  function render() {
                      if (!wordBank || !answerBoard) return;
                      wordBank.innerHTML = '';
                      answerBoard.innerHTML = '';
                      bankWords.forEach(word => createWordButton(word, wordBank));
                      answerWords.forEach(word => createWordButton(word, answerBoard));
                      checkSubmitButtonState();
                  }

                  function createWordButton(word, parent) {
                      const btn = document.createElement('button');
                      btn.textContent = word.text;
                      btn.className = wordBtnClasses;
                      btn.dataset.wordId = word.id;
                      parent.appendChild(btn);
                  }

                  function resetState() {
                      bankWords = JSON.parse(JSON.stringify(initialBankWords));
                      answerWords = [];
                      render();
                  }

                  function initializeSentenceQuiz() {
                       // HTMLì—ì„œ ì½ëŠ” ëŒ€ì‹ , JavaScript ë³€ìˆ˜(question)ì—ì„œ ì§ì ‘ ë‹¨ì–´ ëª©ë¡ì„ ê°€ì ¸ì™€ ì´ˆê¸°í™”
                      initialBankWords = (question.shuffledWords || []).map((wordText, index) => ({
                          id: index, text: wordText
                      }));
                      resetState();
                  }
                    if(question){
                      initializeSentenceQuiz();

                      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (í´ë¦­ìœ¼ë¡œ ë‹¨ì–´ ì´ë™)
                      wordBank.addEventListener('click', (e) => moveWord(e, bankWords, answerWords, render));
                      answerBoard.addEventListener('click', (e) => moveWord(e, answerWords, bankWords, render, true));
                      resetBtn?.addEventListener('click', resetState);

                      // ë“œë˜ê·¸ì•¤ë“œë¡­ (ìˆœì„œ ë³€ê²½)
                      new Sortable(answerBoard, {
                          animation: 150,
                          ghostClass: 'sortable-ghost',
                          onEnd: (evt) => {
                              const movedItem = answerWords.splice(evt.oldIndex, 1)[0];
                              answerWords.splice(evt.newIndex, 0, movedItem);
                          }
                      });
                  }
              }
              else { // ë‹¨ì–´ í€´ì¦ˆ ë¡œì§
                  const choicesArea = document.getElementById('choices-area');
                  if (choicesArea) {
                      choicesArea.addEventListener('click', (e) => {
                          const clickedBtn = e.target.closest('.answer-btn');
                          if (!clickedBtn) return;
                          choicesArea.querySelectorAll('.answer-btn').forEach(btn => btn.classList.remove('selected'));
                          clickedBtn.classList.add('selected');
                          selectedAnswer = clickedBtn.dataset.answer;
                          checkSubmitButtonState();
                      });
                  }
              }

              // --- ê³µí†µ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë° í•¨ìˆ˜ ---

              // ë°œìŒ ë“£ê¸° ë²„íŠ¼ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                pronAudioBtn?.addEventListener('click', () => {
                    const audioSrc = pronAudioBtn.dataset.audioSrc;
                    if (!audioSrc) return;

                    // ì´ì „ì— ì¬ìƒ ì¤‘ì¸ ì˜¤ë””ì˜¤ê°€ ìˆìœ¼ë©´ ì •ì§€ì‹œí‚µë‹ˆë‹¤.
                    if (currentPlayingAudio) {
                        currentPlayingAudio.pause();
                    }

                    // ìƒˆ ì˜¤ë””ì˜¤ ê°ì²´ë¥¼ ìƒì„±í•˜ê³  ì¬ìƒí•©ë‹ˆë‹¤.
                    currentPlayingAudio = new Audio(audioSrc);
                    currentPlayingAudio.play();
                });

              submitBtn?.addEventListener('click', () => {
                  allowNavigation = true; // ì œì¶œë„ ì˜ë„ëœ ì´ë™ì´ë¯€ë¡œ ê¹ƒë°œì„ ì˜¬ë¦¼
                  let answeredDto;
                  if (isSentenceQuiz) {
                      const submittedWords = Array.from(answerBoard.querySelectorAll('.word-btn')).map(btn => btn.textContent.trim());
                      if (submittedWords.length === 0) { alert('ë‹¨ì–´ë¥¼ ì˜®ê²¨ ë¬¸ì¥ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”!'); allowNavigation = false; return; }
                      answeredDto = { exprId: question.exprId, submitSentence: submittedWords };
                  } else {
                      if (!selectedAnswer) { alert('ë‹µì„ ì„ íƒí•´ì£¼ì„¸ìš”!'); allowNavigation = false; return; }
                      answeredDto = { exprId: question.exprId, submitWord: selectedAnswer.trim() };
                  }
                  disableAllAnswerButtons();
                  submitAnswer(answeredDto);
              });

              // skipê³¼ next ë²„íŠ¼ ëª¨ë‘ goToNextQuestion í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ë„ë¡ í†µì¼
              skipBtn?.addEventListener('click', () => goToNextQuestion());
              nextBtn?.addEventListener('click', () => goToNextQuestion());

              function moveWord(e, sourceArray, targetArray, renderCallback, sort = false) {
                  const clickedBtn = e.target.closest('.word-btn');
                  if (!clickedBtn || clickedBtn.classList.contains('sortable-drag')) return;
                  const wordId = clickedBtn.dataset.wordId;
                  const wordIndex = sourceArray.findIndex(w => String(w.id) === wordId);
                  if (wordIndex > -1) {
                      const [wordToMove] = sourceArray.splice(wordIndex, 1);
                      targetArray.push(wordToMove);
                      if (sort) targetArray.sort((a, b) => a.id - b.id);
                      renderCallback();
                  }
              }

              function submitAnswer(answeredDto) {
                  const token = document.querySelector("meta[name='_csrf']")?.content;
                  const header = document.querySelector("meta[name='_csrf_header']")?.content;
                  const headers = { 'Content-Type': 'application/json' };
                  if (token && header) headers[header] = token;

                  fetch('/quiz/submit', { method: 'POST', headers: headers, body: JSON.stringify(answeredDto) })
                      .then(response => response.ok ? response.json() : response.text().then(text => Promise.reject(text)))
                      .then(gradedResult => {
                          showFeedback(gradedResult);
                          toggleActionButtons();
                      })
                      .catch(err => {
                          console.error("ì±„ì  ì˜¤ë¥˜:", err);
                          feedbackArea.innerHTML = `<p class="text-red-600">ì±„ì  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>`;
                      });
              }

              function showFeedback(gradedResult) {
                  let messageText, messageColor, answerText = '';

                  if (gradedResult.correct) {
                      messageText = 'ì •ë‹µì…ë‹ˆë‹¤! ';
                      messageColor = 'text-green-600'; // ì •ë‹µì¼ ë•Œ ì´ˆë¡ìƒ‰
                  } else {
                      messageText = 'ì˜¤ë‹µì…ë‹ˆë‹¤.';
                      messageColor = 'text-red-600'; // ì˜¤ë‹µì¼ ë•Œ ë¹¨ê°„ìƒ‰
                      // ì •ë‹µ í…ìŠ¤íŠ¸ë¥¼ ì¤€ë¹„
                      let correctAnswer = gradedResult.correctWordAnswer || (gradedResult.correctSentenceAnswer || []).join(' ') || '';
                      answerText = `<p class="text-lg font-medium text-gray-700 mt-1">ì •ë‹µ: ${correctAnswer}</p>`;
                  }

                  // ì •ë‹µ/ì˜¤ë‹µ ëª¨ë‘ ë™ì¼í•œ HTML êµ¬ì¡°ì™€ ìŠ¤íƒ€ì¼ì„ ì‚¬ìš©
                  feedbackArea.innerHTML = `
                      <div class="text-center">
                          <p class="text-2xl font-bold ${messageColor}">${messageText}</p>
                          ${answerText}
                      </div>
                  `;
              }

              function toggleActionButtons() {
                  // ì œì¶œ ë²„íŠ¼ì€ ìˆ¨ê¸°ê³ , ë‹¤ìŒ ë²„íŠ¼ì€ ê·¸ ìë¦¬ì— í‘œì‹œ
                  if (submitBtn) submitBtn.classList.add('hidden');
                  if (nextBtn) nextBtn.classList.remove('hidden');

                  // ê±´ë„ˆë›°ê¸°ì™€ ì´ˆê¸°í™” ë²„íŠ¼ì„ ë¹„í™œì„±í™”
                  if (skipBtn) {
                      skipBtn.disabled = true;
                      skipBtn.classList.add('opacity-50', 'cursor-not-allowed');
                  }
                  if (resetBtn) {
                      resetBtn.disabled = true;
                      resetBtn.classList.add('opacity-50', 'cursor-not-allowed');
                  }
              }

              function disableAllAnswerButtons() {
                  if (isSentenceQuiz) {
                      const sortableAnswer = Sortable.get(document.getElementById('answer-board'));
                      if (sortableAnswer) sortableAnswer.option('disabled', true);
                      wordBank.querySelectorAll('.word-btn').forEach(btn => btn.style.pointerEvents = 'none');
                      answerBoard.style.pointerEvents = 'none';
                  } else {
                      document.querySelectorAll('.answer-btn').forEach(btn => {
                          btn.disabled = true;
                          btn.classList.add('cursor-not-allowed', 'opacity-70');
                      });
                  }
              }

              function goToNextQuestion() {
                  allowNavigation = true;
                  if (currentIndex + 1 >= totalQuestions) {
                      fetch('/quiz/result').then(res => res.json()).then(showFinalResult);
                  } else {
                      window.location.href = `/quiz/take?index=${currentIndex + 1}`;
                  }
              }

              function showFinalResult(finalResult) {
                    if (!quizContainer) return;

                    // ì§„í–‰ë°” ìˆ¨ê¸°ê¸°
                    const progressWrapper = document.querySelector('.w-full.bg-gray-200.rounded-full.h-4');
                    if (progressWrapper) progressWrapper.style.display = 'none';
                    // í€´ì¦ˆ ê°œìˆ˜ ìˆ¨ê¸°ê¸°
                    const quizCountText = document.querySelector('.text-sm.font-medium.text-gray-600.text-right');
                    if (quizCountText) quizCountText.style.display = 'none';
                    // X ë‚˜ê°€ê¸° ë²„íŠ¼ ìˆ¨ê¸°ê¸°
                    const exitBtn = document.getElementById('exit-quiz-trigger');
                    if (exitBtn) exitBtn.style.display = 'none';

                    // quizContainer(ë°”ê¹¥ ë°•ìŠ¤)ì˜ ë°°ê²½/ê·¸ë¦¼ì ì—†ì• ê¸°
                      quizContainer.classList.remove('bg-white', 'rounded-lg', 'shadow-lg');
                      quizContainer.classList.add('bg-transparent', 'shadow-none');

                      // ê²°ê³¼ í™”ë©´ HTMLì„ ìƒì„±
                      quizContainer.innerHTML = `
                          <div class="max-w-md mx-auto bg-white border border-gray-300 border-2 rounded-lg shadow p-6 space-y-4">
                              <h2 class="text-2xl font-bold text-center text-gray-900 mb-6">í€´ì¦ˆ ê²°ê³¼</h2>
                              <div class="space-y-2 text-lg font-semibold">
                                  <div class="flex justify-between p-4 bg-gray-50 rounded-lg"><span>ì´ ë¬¸ì œ</span><span class="font-bold">${finalResult.totalQuestions}</span></div>
                                  <div class="flex justify-between p-4 bg-gray-50 rounded-lg"><span>ë§ì€ ê°œìˆ˜</span><span class="font-bold text-green-600">${finalResult.correctCount}</span></div>
                                  <div class="flex justify-between p-4 bg-gray-50 rounded-lg"><span>íšë“ ê³¨ë“œ <span title="ê³¨ë“œëŠ” íšë“ë‚ ì§œì™€ ì˜¤ë‹µíšŸìˆ˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì°¨ë“± ì§€ê¸‰ë©ë‹ˆë‹¤."> ğŸ’°</span></span><span class="font-bold text-yellow-500">${finalResult.rewardGold}</span></div>
                              </div>
                              <div class="mt-8">
                                  <a id="back-to-expressions-btn" href="/expressions" class="w-full inline-block px-4 py-2 bg-[#8CCE47] hover:brightness-110 border-b-4 border-green-600 text-white rounded-xl font-bold text-base text-center uppercase transition-colors">ë‹¨ì–´ì¥ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
                              </div>
                           </div>
                      `;

                      // ë™ì ìœ¼ë¡œ ìƒì„±ëœ ë²„íŠ¼ì„ ì°¾ì•„ì„œ í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ì¶”ê°€
                      const backToExpressionsBtn = document.getElementById('back-to-expressions-btn');
                      backToExpressionsBtn?.addEventListener('click', (e) => {
                          // a íƒœê·¸ì˜ ê¸°ë³¸ ë™ì‘(ì¦‰ì‹œ ì´ë™)ì„ ë§‰ê¸°
                          e.preventDefault();

                          // í˜ì´ì§€ë¥¼ ë– ë‚˜ê¸° ì „ì— 'ê¹ƒë°œ'ì„ ì˜¬ë ¤ì„œ beforeunload ê²½ê³  ë§‰ê¸°
                          allowNavigation = true;

                          // JavaScriptë¡œ í˜ì´ì§€ë¥¼ ì´ë™
                          window.location.href = backToExpressionsBtn.href;
                      });


                  // í•˜ë‹¨ì˜ ì•¡ì…˜ ë²„íŠ¼ë“¤ì„ ìˆ¨ê¹€
                  const actionButtons = document.getElementById('action-buttons');
                  if (actionButtons) actionButtons.style.display = 'none';
              }

          });
    </script>
</th:block>

<th:block layout:fragment="main">
    <div class="h-full p-4 flex flex-col bg-gray-50">

        <div id="exit-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
            <div class="bg-white rounded-2xl shadow-lg w-full max-w-sm p-8 text-center">
                <img th:src="@{/icons/exit-quiz.gif}" alt="sad-icon" class="w-24 h-24 mx-auto mb-4"/>

                <h3 class="text-xl font-bold text-gray-800 mb-6">í•™ìŠµì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h3>

                <div class="flex flex-col gap-3">
                    <button id="continue-quiz-btn" class="w-full px-3 py-3 bg-[#8CCE47] hover:brightness-110 border-b-4 border-green-600 text-white rounded-xl font-bold text-base uppercase transition-colors">
                        ê³„ì† í•™ìŠµí•˜ê¸°
                    </button>
                    <button id="exit-quiz-btn" class="w-full px-3 py-3 text-red-500 hover:bg-green-50 rounded-xl font-bold text-base uppercase transition-colors">
                        í•™ìŠµ ì¢…ë£Œí•˜ê¸°
                    </button>
                </div>
            </div>
        </div>

        <div class="flex-shrink-0 w-full max-w-4xl mx-auto">
            <div class="flex items-center gap-4 pt-6 pb-3">
                <a id="exit-quiz-trigger" th:href="@{/quiz/exit}"
                   class="flex-shrink-0 flex items-center justify-center h-8 w-8 rounded-full text-gray-500 hover:bg-gray-200 hover:text-gray-800 transition-colors">
                    <i class="fa-solid fa-xmark fa-xl"></i>
                </a>
                <div class="w-full bg-gray-200 rounded-full h-4">
                    <div id="progressBar" class="bg-[#8CCE47] h-4 rounded-full"></div>
                </div>
                <div class="flex-shrink-0">
                    <p class="text-sm font-medium text-gray-600 text-right">
                        <span th:text="${currentIndex + 1}" class="font-bold text-[#8CCE47] text-xl">1</span> / <span th:text="${totalQuestions}" class="text-lg">10</span>
                    </p>
                </div>
            </div>
        </div>

        <main class="flex-grow w-full flex items-center justify-center">
            <div id="quiz-container" class="w-full max-w-4xl p-8 bg-white relative pb-24 rounded-lg shadow-md">

                <div class="text-center text-gray-400 text-xl font-bold">
                    <p th:if="${question.exprType.name() == 'WORD'}">ì˜¬ë°”ë¥¸ ì˜ë¯¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
                    <p th:if="${question.exprType.name() == 'SENTENCE'}">ë¬¸ì¥ì˜ ìˆœì„œë¥¼ ì˜¬ë°”ë¥´ê²Œ ë°°ì—´í•˜ì„¸ìš”.</p>
                </div>
                <hr class="my-6">

                <div class="mb-8 flex items-center justify-center gap-3">
                    <p class="text-2xl font-medium text-center text-gray-900" th:text="${question.questionText}"></p>
                    <span th:if="${question.pronAudio != null}"
                          id="pron-audio-btn"
                          th:data-audio-src="${question.pronAudio}"
                          class="text-gray-400 hover:text-blue-600 cursor-pointer transition-colors">
                <i class="fa-solid fa-volume-high fa-lg"></i>
            </span>
                </div>

                <div class="flex flex-col flex-grow" th:classappend="${question.exprType.name() == 'WORD'} ? 'justify-center' : ''">
                    <div th:if="${question.exprType.name() == 'SENTENCE'}" class="flex flex-col flex-grow">
                        <div>
                            <div id="answer-board" class="flex justify-center items-center flex-wrap gap-2 p-4 border-2 border-dashed rounded-lg min-h-[120px] mb-2"></div>
                            <div class="flex justify-end">
                                <button id="resetBtn" class="flex items-center gap-2 bg-gray-200 hover:bg-gray-300 text-gray-600 px-3 py-1.5 rounded-lg text-sm">
                                    <i class="fa-solid fa-rotate-left"></i>
                                    <span>ì´ˆê¸°í™”</span>
                                </button>
                            </div>
                        </div>
                        <div id="word-bank" class="flex flex-wrap content-start gap-3 justify-center items-center rounded-lg p-4 bg-gray-50 mt-2 min-h-[120px]">
                            <button th:if="${question.shuffledWords != null}" th:each="word : ${question.shuffledWords}" th:text="${word}"
                                    class="word-btn flex-none px-6 py-2 bg-white border border-gray-200 border-b-4 rounded-2xl text-gray-600 font-bold transition-all hover:bg-gray-50 active:border-b-0 active:translate-y-px"></button>
                        </div>
                    </div>
                    <div id="choices-area" th:if="${question.exprType.name()=='WORD'}" class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-4 place-content-center">
                        <button th:if="${question.multipleChoices != null}" th:each="choice : ${question.multipleChoices}" type="button" class="answer-btn p-4 text-lg text-left text-gray-700 bg-white border border-gray-200 border-b-4 rounded-2xl text-gray-600 font-bold transition-all hover:bg-gray-50 active:border-b-0 active:translate-y-px" th:data-answer="${choice}">
                            <span th:text="${choice}" class="font-bold"></span>
                        </button>
                    </div>
                </div>
                <div id="feedback-area" class="absolute bottom-5 left-0 right-0 text-center"></div>
            </div>
        </main>

        <div class="flex-shrink-0 w-full max-w-4xl mx-auto">
            <div id="action-buttons" class="flex-shrink-0 mt-8 pb-8 flex justify-between items-center">
                <button id="skipBtn" class="px-6 py-2 bg-white border border-gray-200 border-b-4 rounded-2xl text-gray-600 font-medium transition-all hover:bg-gray-50 active:border-b-0 active:translate-y-px">
                    ê±´ë„ˆë›°ê¸°
                </button>
                <div class="relative w-32 h-12">
                    <button id="submitBtn" class="absolute inset-0 bg-[#8CCE47] hover:brightness-110 text-white w-full h-full rounded-2xl font-medium border-b-4 border-green-600 transition-all active:border-b-0 active:translate-y-px disabled:bg-gray-300 disabled:border-gray-400 disabled:cursor-not-allowed" disabled>
                        ì œì¶œ
                    </button>
                    <button id="nextBtn" class="absolute inset-0 bg-[#8CCE47] hover:brightness-110 text-white w-full h-full rounded-2xl font-medium border-b-4 border-green-600 transition-all active:border-b-0 active:translate-y-px hidden">
                        ë‹¤ìŒ
                    </button>
                </div>
            </div>
        </div>

    </div>
</th:block>
</html>