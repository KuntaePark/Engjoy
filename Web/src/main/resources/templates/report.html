<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{fragment/default}">

<th:block layout:fragment="css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cal-heatmap/dist/cal-heatmap.css">
    <style>
        /* ì—°ë„ ì„¸ë¡œ ì •ë ¬ */
        .year-labels {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            padding-right: 12px;
            color: #4b5563; /* Tailwind gray-600 */
            font-size: 14px;
        }
        .year-labels > div {
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            margin-bottom: 20px;
            user-select: none;
        }

        /* ìš”ì¼ í‘œì‹œ */
        .weekday-labels {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            font-size: 12px;
            color: #4b5563; /* Tailwind gray-600 */
            margin-bottom: 6px;
            user-select: none;
        }

        /* cal-heatmap ê¸°ë³¸ í°íŠ¸ í¬ê¸° ì¡°ì ˆ */
        #cal-heatmap .ch-month, #cal-heatmap .ch-day {
            font-size: 10px;
        }

        /* Tooltip ìŠ¤íƒ€ì¼ (ì„ íƒ ì‚¬í•­) */
        .ch-tooltip {
            padding: 4px 8px;
            background-color: #333;
            color: #fff;
            border-radius: 4px;
            font-size: 12px;
        }

        #cal-heatmap rect.ch-subdomain-bg{
          stroke: #ccc;
          stroke-width: 0.5px;
          shape-rendering: crispEdges;
        }

                #cal-heatmap svg {
          overflow: visible !important;
        }


        /* ì „ì²´ í™”ë©´ì„ ë®ëŠ” ì˜¤ë²„ë ˆì´ */
.modal-overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal-overlay.hidden {
  display: none !important;
}

/* ëª¨ë‹¬ ì½˜í…ì¸  ë°•ìŠ¤ */
.modal-overlay .modal-content {
  background: #fff;
  border-radius: 8px;
  width: 90%;
  max-width: 600px;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
}




    </style>
</th:block>
<th:block layout:fragment="script">
    <script type="text/javascript" src="https://d3js.org/d3.v7.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/cal-heatmap/dist/cal-heatmap.min.js"></script>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/cal-heatmap/dist/plugins/Tooltip.min.js"></script>


    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', () => {
            const reportData = /*[[${report}]]*/ null;

            if (reportData && reportData.dailyLearningCounts) {
                const heatmapData = Object.entries(reportData.dailyLearningCounts).map(([dateStr, count]) => {
                    return {
                        date: dateStr,
                        value: count > 0 ? 1 : 0
                    };
                });

                const cal = new CalHeatmap();
                    cal.paint({
                    data: {
                        source: heatmapData,
                        x: 'date',
                        y: 'value'
                    },
                    date: { start: new Date(new Date().setMonth(new Date().getMonth() - 11)) },
                    range: 12,
                    scale: {
                        color: {
                            type: 'threshold',
                            domain: [1],
                            range: ['#eee', '#34d399']
                        }
                    },
                    domain: { type: 'month' },
                    subDomain: { type: 'day', radius: 2, width: 11, height: 11 },  // ì—¬ê¸°ë§Œ ë°”ê¿ˆ
                    itemSelector: '#cal-heatmap'
                },
                [
                    [Tooltip, {
                        text: function (date, value, dayjsDate) {
                            return dayjsDate.format('YYYY-MM-DD');
                        }
                    }]
                ]);
            }

            // ì „ì—­ì— ì„ ì–¸
            let wrongItems = [];

            function renderWrongList(items) {
              const tbody = document.getElementById('wrong-answer-list');
              tbody.innerHTML = '';  // ê¸°ì¡´ í–‰ ì‚­ì œ

              items.forEach(item => {
                // DTO êµ¬ì¡°ì— ë§ì¶° ì§ì ‘ êº¼ë‚´ê¸°
                const word    = item.wordText;
                const meaning = item.meaning;
                const count   = item.incorrectCount;
                const last    = item.lastReviewDate;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                  <td class="px-6 py-4 break-words">${word}</td>
                  <td class="px-6 py-4 break-words">${meaning}</td>
                  <td class="px-6 py-4">${count}</td>
                  <td class="px-6 py-4">${last}</td>
                `;
                tbody.append(tr);
              });
            }

            // ëª¨ë‹¬ ì—´ê¸° & ë°ì´í„° ë¡œë“œ
            const wrongBtn    = document.getElementById('wrong-answer-btn');
            const wrongModal  = document.getElementById('wrong-answer-modal');
            const closeBtns   = wrongModal.querySelectorAll('.close-modal-btn');
            const sortButtons = wrongModal.querySelectorAll('.wrong-sort-btn');

            wrongBtn.addEventListener('click', async () => {
              const res = await fetch('/report/wrong');
              if (!res.ok) return console.error(res.statusText);

              wrongItems = await res.json();
              wrongItems.sort((a,b) => new Date(b.lastReviewDate) - new Date(a.lastReviewDate));
              renderWrongList(wrongItems);

              sortButtons.forEach(btn => {
                if (btn.dataset.sort === 'recent'){
                    btn.classList.add('text-blue-600');
                    btn.classList.remove('text-gray-500');
                } else {
                    btn.classList.add('text-gray-500');
                    btn.classList.remove('text-blue-600');
                }
              });
                wrongModal.classList.remove('hidden');
            });


            // ëª¨ë‹¬ ë‹«ê¸°
            closeBtns.forEach(btn =>
              btn.addEventListener('click', () => {
                wrongModal.classList.add('hidden');
              })
            );


            // ì •ë ¬ ì²˜ë¦¬
            sortButtons.forEach(btn =>
              btn.addEventListener('click', () => {
                sortButtons.forEach(buttonToReset => {
                    buttonToReset.classList.remove('text-blue-600');
                    buttonToReset.classList.add('text-gray-500');
                });

                btn.classList.remove('text-gray-500');
                btn.classList.add('text-blue-600');

                const type = btn.dataset.sort;       // "recent" or "frequency"
                const sorted = [...wrongItems];      // ì›ë³¸ í›¼ì† ë°©ì§€ ë³µì‚¬

                if (type === 'recent') {
                  sorted.sort((a, b) =>
                    new Date(b.lastReviewDate) - new Date(a.lastReviewDate)
                  );
                } else {
                  sorted.sort((a, b) =>
                    b.incorrectCount - a.incorrectCount
                  );
                }

                renderWrongList(sorted);
              })
            );

        });
    </script>
</th:block>

<th:block layout:fragment="main">
    <div class="container mx-auto p-6">
        <h1 class="text-2xl font-bold mb-4">ğŸ“˜ í•™ìŠµ ë¦¬í¬íŠ¸</h1>

        <div class="grid grid-cols-3 gap-4 mb-6">
            <div class="p-4 bg-blue-100 rounded">
                ì£¼ê°„ í•™ìŠµ ìˆ˜<br><strong id="weekly-review-count" th:text="${report.weekReviews}">0</strong>
            </div>
            <div class="p-4 bg-red-100 rounded">
                ì£¼ê°„ ì˜¤ë‹µ ìˆ˜<br><strong id="incorrect-count" th:text="${report.weekIncorrect}">0</strong>
                <button type="button" id="wrong-answer-btn" class="bg-white hover:bg-white text-gray-700 font-semibold px-4 py-2 rounded-md text-sm flex items-center gap-2">
                    <i class="fa-solid fa-pen-to-square"></i> ì˜¤ë‹µ
                </button>
            </div>
        </div>

        <section class="mt-10">
            <h2 class="text-xl font-semibold mb-4">ğŸ“… ì¼ë³„ í•™ìŠµ íˆíŠ¸ë§µ</h2>

            <div style="display: flex; align-items: flex-start;">
                <div style="writing-mode: vertical-rl;transform: rotate(180deg);font-size: 30px;line-height: 11px; height: 77px; /* 11px * 7ì¤„ */
                color: #4b5563; margin-right: 20px; user-select: none;">
                    <span th:text="${#dates.format(new java.util.Date(), 'yyyy')}"></span>
                </div>

                <div>
                    <div style="display: flex; flex-direction: column; justify-content: space-between; height: 77px; /* 11px * 7ì¤„ */
                        font-size: 9px; color: #4b5563; margin-right: 8px; width: 14px; user-select: none; flex-shrink: 0; ">
                        <div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div>
                    </div>
                </div>

                <div id="cal-heatmap" style="margin-left:2px; flex-grow:1;"></div>
            </div>
        </section>

        <div id="wrong-answer-modal" class="modal-overlay hidden">
            <div class="modal-content bg-white rounded-lg p-6 shadow-lg max-w-3xl w-full overflow-y-auto">
                <div class="modal-header relative flex items-center justify-center mb-4 pb-2 border-b bg-[#8CCE47]">
                    <h4 class="font-bold text-lg text-gray-800">ì˜¤ë‹µ ë…¸íŠ¸</h4>
                    <button class="close-modal-btn absolute right-4 text-gray-400 hover:text-gray-700 text-2xl transition-colors">
                        &times;
                    </button>
                </div>

                <div class="mb-4 text-right space-x-2">
                    <button data-sort="recent" class="wrong-sort-btn text-sm font-semibold text-blue-600">ìµœê·¼ìˆœ</button>
                    <button data-sort="frequency" class="wrong-sort-btn text-sm text-gray-500">ë¹ˆë„ìˆœ</button>
                </div>

                <div class="max-h-96 overflow-y-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3">ë‹¨ì–´</th>
                            <th scope="col" class="px-6 py-3">ëœ»</th>
                            <th scope="col" class="px-6 py-3">ì˜¤ë‹µ íšŸìˆ˜</th>
                            <th scope="col" class="px-6 py-3">ë§ˆì§€ë§‰ ë³µìŠµì¼</th>
                        </tr>
                        </thead>
                        <tbody id="wrong-answer-list">
                        <!-- JSë¡œ ì±„ì›Œì§ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</th:block>
</html>